name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # Weekly on Sunday at midnight - catch upstream breakage
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      # Optional: use cachix for faster builds
      # - uses: cachix/cachix-action@v15
      #   with:
      #     name: your-cache-name
      #     authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      
      - name: Check flake
        run: nix flake check --print-build-logs
      
      - name: Build default package
        run: nix build .# --print-build-logs
      
      - name: Build full package (with deps)
        run: nix build .#full --print-build-logs

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Run ERT test suite
        run: nix run .#test
      
      - name: Byte-compile (catch undefined refs)
        run: nix run .#byte-compile

  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Run checkdoc
        run: nix run .#lint
        continue-on-error: true  # checkdoc is advisory

  smoke-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Smoke test - load init
        run: |
          nix run .# -- --batch \
            -l $PWD/init.el \
            --eval "(message \"Init loaded successfully\")"
      
      - name: Smoke test - check startup time
        run: |
          nix run .# -- --batch \
            -l $PWD/init.el \
            --eval "(message \"Startup time: %s\" (emacs-init-time))"

  # Scheduled: check for upstream breakage
  update-check:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Update flake inputs
        run: nix flake update
      
      - name: Build with updated inputs
        run: nix build .#full --print-build-logs
      
      - name: Run tests with updated inputs
        run: nix run .#test
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Weekly upstream check failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The weekly upstream compatibility check failed. 
            
            This likely means a dependency update broke something.
            
            **Action needed:** 
            1. Run \`nix flake update\` locally
            2. Check what changed in \`flake.lock\`
            3. Fix any breakage
            4. Or pin to a known-good version
            
            [View failed run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['upstream-breakage', 'automated']
            });
